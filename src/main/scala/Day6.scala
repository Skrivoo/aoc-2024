import Day6.Position

import scala.annotation.tailrec

object Day6 {
  private val myInput = ".....#..#................#...#.....#.......................................................#.............................##.......\n......................#..............................................................#..............#..........................#..\n.........#........................#.....................................................#..............#...........#........##....\n..........#......................#.....#...#............#..........................#.....#........................................\n#....................................................................................................................#............\n.#....#......................#.......................#...............................#...#.....#...................#........#.....\n..#..#.......................##........#...............................................................#........#.........#.......\n..............................................................#...#.........#..#..................................................\n.............####..................................#................#..#.....................................#.....#..............\n..........#................#................................................#........................#.....#......................\n..............................................#.........#.....................#..................#.......................#........\n.........................................##..#.................................#.....#............................................\n............#..#...#...............................#.#.....#...............#...............................#..............#.#.#..#\n.................#..........#..#....#.....................#......................................##............#..................\n.......#....#.....................#......##...................#..............#.................#........#..#......#...............\n...............................................#.............#....................................................................\n..............#..............................................##..................#..........................#............#........\n................#.......................#..#............................................................#..........#..#.........#.\n.#.......................###............#.........#.................................................#.............................\n........#......................................................................................#.....#.......#...#................\n#.#.........................#..#.............................................#....#........................#......................\n.......#.....#...............................#.....#......................#.................................#.....#...#...........\n................................................................................................#............#....................\n.......#......#...............#...#............................#................................#................................#\n.#.....................................................................................................................#......#...\n...........#..........................................#........#...................#..............................................\n....#......................................................................................#.....##.#...................#.........\n...#..........................................................................##.......................................#.....#....\n#........#................#...............#.........#..#.#..............##..............#........#............#....#.....#........\n......#......................................#...............#....#..#...........................#................................\n#..............................................................................#............#...#..#....................#......#..\n.......#.........................................#.........#.......#....................................#.........................\n......#......#.............................................#.....................#...........#.............#..#...................\n#.......................#........#............................................##..............................#...................\n..........................................................................#........................................#....#......#..\n..........#..#...............................................#............................#.#..............................#......\n....#...........#..#...................................#................................................................#.........\n..............#..........#...............#....#.....................................#.......................#.....................\n.............#........#....#.........#...............#.........#..................................................................\n.#......#...................#.......#...........................................................................#.............#...\n.............##...........#.........................................#......................#.......................#..............\n.....#................#.....#...................##.......#......#...........#.......#............................................#\n.#..#.............................................................#..............................................#................\n...#......#............................#..........................................................................................\n...................................................................................#..............................................\n#...................................#...................##..................#...............................................#.....\n................#.....#...........................#...............................................................................\n.................................#............#........................................................#.............#............\n..................#......#........................................................#..^.....#......................................\n..#.....#.................................................#........#.........................................................#..#.\n................#..............................#....................................................#.............................\n................#....#..........................................#............................#....................................\n...............#.......................................#.....................................#..............................#.....\n..................................................#............#..............#........##.#.....................................#.\n.#..................................#......#..#............#.................#.............#......#..#.......................#....\n..................#..............................#..........................#..........................##............#.......#....\n.........#..................................................................#...................#..........................#......\n................#....................................#............#............................................................#..\n..##..........#.#..#........................#....#.................................#.............................................#\n............................................#.........................................................#..#...................#...#\n.......................................#......................................................................#...................\n....#.......................#...#.........................................................................#................#......\n...........#...........#............#.....#...#...................#........................................#.................##...\n....#...........................................................................................#.................................\n..............................................................................#.#.............................................#...\n.........#..#..............................................#......................................................................\n#...................#........#............#.......#.....................#................#.#.#............#..................#....\n.......................#................#.....#...........#.....................#...........................#..........#.........#\n........................................................................#.#.....................#.................................\n...#.................................................#..........................#........#.......................#................\n............................#...........#.......#.................................#.##...........#............................#...\n...##.....................................#.........................#...........#...................................#.............\n#.#..#................................#.........#..#.#..........#......................#............#......................#......\n....#.............................................................#...............................................................\n...............#.#......#........................................................................#.........................#......\n................#.....#...#...............#.........................................#....#...........................#.......#....\n...............#.........................................................................#........................................\n..........................#..##...................................................................................................\n.##....................#..#.....................#..............................................#........................#.........\n............................................................................................#............#........................\n#...................#...#......................#...............#............#....................................#................\n...........................#........#......................................................................#......................\n................................#...#...#.#.......#.................#.......#................##...................................\n........................#.......................#.................................................................................\n#...#...............#.........................................................................#.......................#...........\n.........#...................#...............................................#...................##..............................#\n.....#............................................................................................................................\n.#.......#...............................................................#.......................#................#..........#....\n....................................#..........#......#...........................................................#.#.#..#...#....\n......................#..............................................##..................#........................................\n....#......#...................#................#..............................................................................#..\n...........#.................##.#...................................................#..#................#.........................\n......#.....#......#...#........#.....................................#....#...........#................#..........#..............\n#.......##.....#........#...........................................#...#..........#.............#........#.......#...............\n......................#......#...................#.........................#........................#..................#...#......\n.....#...........#...#.........................##.......#.....................................#...................................\n....................................................................#.............................................................\n........#...............#.........................................................................................................\n.......................#.........................#..........................................#.#....#..#....#......................\n........................##............................................................#.....#.........#....#......#..#............\n........................#........#..................#................#.#.##............#..........................................\n.......................................................#.........................#...............##...................##....#...#.\n........#...#.............#...........#........#......................#...#.........#..#..................#.#............#........\n#.#....................#..........................................#...................................................#........#..\n...............................................#............#.....#.#...........#........#.#....................................#.\n......#..........................................#............................................................#..........#...#...#\n....................#......................................#....#..............................#....................#.............\n......................#.#.....#......#....#..#....................................................................................\n.....#..........................................#.........#...................................#................#.......#..........\n........##....................................................................#...................................#.............#.\n#.........................................#..#....#................#.#.....#....................#............................#....\n#....#..#..........#..................#......................#....................................................................\n...................#..#....#...................#...........................#.#..#............#......#................#.......#.#..\n...............#......................................................#......#..#..............#.....................#............\n............#.....................#.........#....#...............#.......#...#...............#.......................##.#.........\n....#............#..................#....#.......................#..............................................#...#.............\n..........................................#....#..........#..#....................#......#......................#...#.............\n............#..........#...........#......#..#......................................................................#.............\n...#.................#.............................................................#..............................................\n.....#.#.........#....................................................#..................#...............#........................\n..#......................##.....#.........#..............#..#............#..#............................................#........\n...................#.....#.........#........#....................#..................................#................#............\n....#.............................#.............................#.......................#.......................#.....#...........\n...#......#....#...........#............................#.....#........#......#...................................................\n........#..........#............................#..#..#.......................................#....#.##...........................\n.......#......##........#.................#.............................................................#....#........#...........\n.....................#............................................#.#......#.....##....#........#.................................\n...........#.....................##.#....#..#.....................................................................................\n....................#......#................................#.....................................................#.......#..#....\n.....................................................#.........#.......................................#.....##..#................"

  private val exampleInput = "....#.....\n.........#\n..........\n..#.......\n.......#..\n..........\n.#..^.....\n........#.\n#.........\n......#..."


  trait Position
  private trait Direction
  private case object Left extends Direction
  private case object Up extends Direction
  private case object Right extends Direction
  private case object Down extends Direction
  private case object Obstruction extends Position
  private case class Field(seen: Boolean, maybeGuard: Option[Guard]) extends Position
  private case class Guard(direction: Direction)
  private object Guard {
    def apply(guardChar: Char): Guard = {
      if (guardChar == '<') {
        Guard(Left)
      } else if (guardChar == '^') {
        Guard(Up)
      } else if (guardChar == '>') {
        Guard(Right)
      } else {
        Guard(Down)
      }
    }
  }

  val input: Array[Array[Position]] = myInput
    .split("\n")
    .map(
      _.map(e =>
        if (e == '#') { Obstruction }
        else if (e == '.') { Field(false, None) }
        else { Field(true, Some(Guard(e))) }
      ).toArray
    )

  def day6task1: Int = {
    val solvedPuzzle: Array[Array[Position]] = solvePuzzle(input)
    getNumberOfSeenFields(solvedPuzzle)
  }

  @tailrec
  private def solvePuzzle(puzzleInput: Array[Array[Position]]): Array[Array[Position]] = {
    if (notPossibleToStepAnother(puzzleInput)) {
      puzzleInput
    } else {
      solvePuzzle(stepOne(puzzleInput))
    }
  }

  private def notPossibleToStepAnother(array: Array[Array[Position]]): Boolean = {
    val maxSizeOfMap = array.length - 1
    val direction = getTheGuardsDirection(array)
    val (x, y) = getCoordinatesOfGuard(array)
    if (
      (x == 0 && direction == Up) ||
      (x == maxSizeOfMap && direction == Down) ||
      (y == 0 && direction == Left) ||
      (y == maxSizeOfMap && direction == Right)
    ) true else false
  }

  private def getTheGuardsDirection(array: Array[Array[Position]]): Direction = {
    array.flatten.collectFirst {
      case Field(_, Some(Guard(direction))) => direction
    }.getOrElse(throw new NoSuchElementException("No guard found in the array"))
  }

  private def getCoordinatesOfGuard(array: Array[Array[Position]]): (Int, Int) = {
    array.zipWithIndex.flatMap { case (row, rowIndex) =>
      row.zipWithIndex.collect {
        case (Field(_, Some(_)), colIndex) => (rowIndex, colIndex)
      }
    }.headOption.getOrElse(throw new NoSuchElementException("No guard found in the array"))
  }


  private def stepOne(array: Array[Array[Position]]): Array[Array[Position]] = {
    val (x, y) = getCoordinatesOfGuard(array)
    val direction = getTheGuardsDirection(array)
    val fieldInFrontOf = direction match {
      case Left => (x, y - 1)
      case Up => (x - 1, y)
      case Right => (x, y + 1)
      case Down => (x + 1, y)
    }
    if (array(fieldInFrontOf._1)(fieldInFrontOf._2) == Obstruction) {
      array.updated(
        x,
        array(x).updated(
          y,
          Field(true, Some(turnRight(Guard(direction))))
        )
      )
    } else {
      val updatedArrayWithGuardRemoved = array.updated(
        x,
        array(x).updated(
          y,
          Field(true, None)
        )
      )
      updatedArrayWithGuardRemoved.updated(
        fieldInFrontOf._1,
        updatedArrayWithGuardRemoved(fieldInFrontOf._1).updated(
          fieldInFrontOf._2,
          Field(true, Some(Guard(direction)))
        )
      )
    }
  }

  private def getNumberOfSeenFields(everyPosition: Array[Array[Position]]): Int = {
    everyPosition.flatten.collect {
      case field: Field if field.seen => field
    }.length
  }

  private def turnRight(guard: Guard): Guard = {
    guard.direction match
      case Down => Guard(Left)
      case Left => Guard(Up)
      case Up => Guard(Right)
      case Right => Guard(Down)
  }

}
